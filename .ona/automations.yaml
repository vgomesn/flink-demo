# .ona/automations.yaml
tasks:
  bootstrap-flink:
    name: Bootstrap Flink
    description: Install Flink 2.0.0 and start cluster with extra task managers
    command: |
      chmod +x ./install_flink.sh
      ./install_flink.sh
      export PATH="$PATH:$(pwd)/flink-2.0.0/bin"
      start-cluster.sh
      taskmanager.sh start
      taskmanager.sh start
      taskmanager.sh start
    triggeredBy:
      - postDevcontainerStart

  build-submit-job:
    name: Build & Submit Job
    description: Build the Maven project and submit the Flink job
    command: |
      export PATH="$PATH:$(pwd)/flink-2.0.0/bin"
      mvn -q -DskipTests clean package
      flink run -d -c com.globomantics.UniqueAdClickAggregator target/flink-unique-clicks-1.0.0.jar out
    triggeredBy:
      - postDevcontainerStart
    dependsOn:
      - bootstrap-flink

services:
  tail-results:
    name: Tail Results
    description: Tail Flink output files
    commands:
      start: |
        mkdir -p out && tail -F out/* 2>/dev/null || true


